<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <!--
      manifest.json provides metadata used when your web app is added to the
      homescreen on Android. See https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/
    -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://bulma.io/vendor/fontawesome-free-5.15.2-web/css/all.min.css">
    <link rel="stylesheet" href="/static/main.css">
    <title>Elm App</title>

    <script src="/static/app.js"></script>

</head>
<body>
    <noscript>
        You need to enable JavaScript to run this app.
    </noscript>
    <div id="root"></div>
    <script>
/**** indexedDB ****/
let request = window.indexedDB.open('eventstore', 1);
request.onupgradeneeded = function(e) {
    console.log('Upgrading database...')
    const db = e.target.result;
    try {
        db.deleteObjectStore('events');
        console.log('Deleted the old database!')
    } catch(e) {}
    let idbstore = db.createObjectStore('events', {autoIncrement:true});
    console.log('Database upgraded')
};

/**** Random UUID ****/
const crypto = window.crypto || window.msCrypto;
const getRandomInts = (n) => {
    const randInts = new Uint32Array(n);
    crypto.getRandomValues(randInts);
    return Array.from(randInts);
};

/**** run Elm ****/
const randInts = getRandomInts(5);
const flags = [randInts[0], randInts.slice(1)]
var app = Elm.Main.init({flags:flags});

/**** subscribe to Ports ****/
/* store an event */
app.ports.storeEvent.subscribe(function(events) {
    let request = window.indexedDB.open('eventstore', 1);
    request.onsuccess = function(e) {
        console.log("open IDB successful");
        const db = e.target.result;
        const transaction = db.transaction(['events'], 'readwrite');
        transaction.oncomplete = function(e) {
            console.log("transaction complete")
        }
        transaction.onerror = function(e) {
            alert("transaction error:" + transaction.error) // FIXME
        }
        events.forEach(function(event) {
            const addrequest = transaction.objectStore('events').add(event)
            addrequest.onsuccess = (e) => {
                console.log('Event successfully added to IDB')
                app.ports.eventStored.send("")
                console.log("Stored info successfully sent back to Elm")
            }
            addrequest.onerror = (e) => {
                addrequest.transaction.abort()
                alert("IDB write failed: " + addrequest.error); // FIXME
            }
        })
        db.close()
    }
    request.onerror = (e) => { alert("open IDB failed: " + request.error); /* FIXME */ }
});
/* read events */
app.ports.getEventstore.subscribe(function() {
    let request = window.indexedDB.open('eventstore', 1);
    request.onsuccess = e => {
            console.log("Sending events to Elm...")
        const openCursor = e.target.result.transaction('events', 'readonly')
                      .objectStore('events').getAll();
        openCursor.onsuccess = e => {
            const events = e.target.result;
            app.ports.receiveEvents.send(events)
            console.log("Successfully sent events to Elm")
        }
        openCursor.onerror = () => {
            alert("transaction error:" + transaction.error) // FIXME
        }
    }
    request.onerror = (e) => { alert("open IDB failed: " + request.error); /* FIXME */ }
});
    </script>
</body>
</html>
