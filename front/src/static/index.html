<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <!--
      manifest.json provides metadata used when your web app is added to the
      homescreen on Android. See https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/
    -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://bulma.io/vendor/fontawesome-free-5.15.2-web/css/all.min.css">
    <link rel="stylesheet" href="/static/main.css">
    <title>Elm App</title>

    <script src="/static/app.js"></script>

</head>
<body>
<noscript>
    You need to enable JavaScript to run this app.
</noscript>
<div id="root"></div>
<script>
/**** indexedDB ****/
let request = window.indexedDB.open('eventstore', 1);
request.onupgradeneeded = function(e) {
    console.log('Upgrading database...')
    const db = e.target.result;
    try {
        db.deleteObjectStore('events');
        console.log('Deleted the old database!')
    } catch(e) {}
    let idbstore = db.createObjectStore('events', {autoIncrement:true});
    console.log('Database upgraded')
};

/**** Random UUID ****/
const crypto = window.crypto || window.msCrypto;
const getRandomInts = (n) => {
    const randInts = new Uint32Array(n);
    crypto.getRandomValues(randInts);
    return Array.from(randInts);
};

/**** run Elm ****/
const randInts = getRandomInts(5);
const flags = [randInts[0], randInts.slice(1)];
var app = Elm.Main.init({flags:flags});

/**** subscribe to Ports ****/




// store an event to IDB
const store = function(send) {
    console.log("Storing events, send= " + send)
    return function(events) {
        let request = window.indexedDB.open('eventstore', 1);
        request.onsuccess = function(e) {
            console.log("open IDB successful");
            const db = e.target.result;
            const transaction = db.transaction(['events'],'readwrite');
            transaction.oncomplete = function(e) {
                console.log("...transaction complete")
            }
            transaction.onerror = function(e) {
                alert("IndexedDB transaction error while storing events:" + transaction.error) // FIXME send error to elm
            }
            events.forEach(function(event) {
                console.log("Adding event to IDB : " + event)
                const addrequest = transaction.objectStore('events').add(event)
                addrequest.onsuccess = (e) => {
                    console.log('...event successfully added to IDB...')
                    if (send) {
                        app.ports.eventsStoredToSend.send(event);
                        console.log("...Success message (with send) sent back from JS to Elm")
                    } else {
                        app.ports.eventsStored.send(event);
                        console.log("...Success message sent back from JS to Elm")
                    }
                }
                addrequest.onerror = (e) => {
                    addrequest.transaction.abort()
                    alert("IndexedDB store request error: " + addrequest.error); // FIXME
                }
            })
            db.close()
        }
        request.onerror = (e) => {
            alert("IndexedDB could not be opened to store events: " + request.error); // FIXME
        }
    };
};
// store an event to IDB
app.ports.storeEvents.subscribe(store(false));
// store events to IDB then tell to send them
app.ports.storeEventsToSend.subscribe(store(true));

// read events from IDB
app.ports.readEvents.subscribe(function() {
    let request = window.indexedDB.open('eventstore', 1);
    request.onsuccess = e => {
            console.log("Sending events from JS to Elm...");
        const openCursor = e.target.result.transaction('events','readonly').objectStore('events').getAll();
        openCursor.onsuccess = e => {
            const events = e.target.result;
            app.ports.eventsReader.send(events);
            console.log("...successfully sent all events from JS to Elm");
        }
        openCursor.onerror = () => {
            alert("IndexedDB transaction error while reading events:" + transaction.error); // FIXME
        }
    }
    request.onerror = (e) => {
        alert("IndexedDB could not be opened to read events: " + request.error); // FIXME
    }
});

/**** Websocket ****/
var socket;
reconnect = function() {
    console.log("NEW WEBSOCKET");
    socket = new WebSocket('ws://localhost:8080/');
    app.ports.wsOpened.send(socket.readyState);
    // Notify Elm the WS has closed
    socket.onopen = function(e) {
            console.log('onopen')
        app.ports.wsOpened.send(socket.readyState);
    };
    // Notify Elm the WS has closed
    socket.onclose = function(e) {
            console.log('onclose')
        app.ports.wsClose.send(socket.readyState);
        delete socket;
    };
    // Notify Elm the WS had error
    socket.onerror = function(e) {
            console.log('onerror')
        app.ports.wsError.send(e.data);
    };
    // Notify Elm we received events from WS
    socket.onmessage = function(e) {
    console.log('onmessage')
        console.log("JS received events from WS and transmitting to Elm: " + e);
        app.ports.eventsReceiver.send(e.data);
    };
    // Elm asks to send events to WS
    app.ports.sendEvents.unsubscribe();
    app.ports.sendEvents.subscribe(function(message) {
            console.log("Sending event to WS... : " + message);
            socket.send(message);
            app.ports.wsSendStatus.send("OK");
            console.log("...sent event to WS");
    
    });
}
// Elm asks to reconnect WS
app.ports.wsConnect.subscribe(reconnect);



    </script>
</body>
</html>
